datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  uid            String   @id
  name           String?
  walletAddress  String?
  email          String
  githubUsername String?
  documents      Document[]
  changes        Change[]
  votes          Vote[]
  collections    Collection[] @relation("UserOwnsCollection")
}

model Document {
  did          String   @id @default(uuid())
  name         String
  description  String
  owner        String
  repo         String
  creator      User?     @relation(fields: [creatorId], references: [uid])
  creatorId    String?
  chaptersFile String
  changes      Change[]
  collectionId String
  collection   Collection @relation(name: "CollectionHasDocuments", fields: [collectionId], references: [coid])
  image_uri    String
  draft        Boolean  @default(true)

  @@index([collectionId])
}

model Change {
  cid              String   @id // the sha256 of owner/repo/prNumber
  suggestor        User     @relation(fields: [suggestorId], references: [uid])
  suggestorId      String
  prNumber         Int
  document         Document @relation(fields: [documentId], references: [did])
  documentId       String
  votes            Vote[]
  title            String
  published        Boolean
  publishedAt      DateTime?

  lastEditFilePath String?
  lastEditFileSha  String?
  branchName       String
  merged           Boolean  @default(false)

  @@index([suggestorId, documentId])
}

model Vote {
  vid      String @id @default(uuid())
  voter    User   @relation(fields: [voterId], references: [uid])
  voterId  String
  change   Change @relation(fields: [changeId], references: [cid])
  changeId String
  vote     Int

  @@index([voterId, changeId])
  @@unique([voterId, changeId])
}

model Collection {
  coid        String     @id @default(uuid())
  name        String     @unique
  description String
  ownerId     String
  owner       User       @relation(name: "UserOwnsCollection", fields: [ownerId], references: [uid])
  documents   Document[] @relation("CollectionHasDocuments")
  image_uri   String
}
